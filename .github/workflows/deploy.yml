name: Deploy to Server

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Add server to known hosts
        run: ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to server
        run: |
          # 使用SSH here-doc语法确保所有命令在远程服务器执行
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            # 设置项目路径 - 所有变量在远程服务器上定义和展开
            PROJECT_PATH="/home/charonspace"
            FRONTEND_PATH="${PROJECT_PATH}/frontend"
            BACKEND_PATH="${PROJECT_PATH}/backend"
            
            # 确保项目目录存在 - 使用引号避免空格问题
            mkdir -p "${PROJECT_PATH}"
            
            # 如果项目已存在，拉取最新代码
            if [ -d "${PROJECT_PATH}/.git" ]; then
              cd "${PROJECT_PATH}"
              echo "=== 更新代码 ==="
              echo "当前分支："
              git branch

              # 检查是否有本地修改
              if ! git diff-index --quiet HEAD --; then
                echo "检测到本地修改，自动暂存..."
                if git stash push -m "Auto-stash by GitHub Actions $(date +%Y%m%d_%H%M%S)"; then
                  echo "本地修改已暂存"
                else
                  echo "警告: 暂存失败，尝试重置..."
                  git reset --hard HEAD
                fi
              else
                echo "没有本地修改"
              fi

              echo "拉取最新代码..."
              # 确保使用SSH URL
              CURRENT_REMOTE=$(git config --get remote.origin.url)
              echo "当前remote URL: $CURRENT_REMOTE"
              if [[ "$CURRENT_REMOTE" == https://* ]]; then
                echo "检测到HTTPS URL，切换为SSH URL..."
                git remote set-url origin git@github.com:KkNeChar0n/ZhixinStudentSaaS.git
                echo "已切换为SSH URL: $(git config --get remote.origin.url)"
              fi

              # 尝试fetch，带重试机制
              RETRY_COUNT=0
              MAX_RETRIES=3
              while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                echo "尝试 fetch (尝试 $((RETRY_COUNT+1))/$MAX_RETRIES)..."
                if git fetch origin; then
                  echo "Fetch 成功"
                  break
                else
                  RETRY_COUNT=$((RETRY_COUNT+1))
                  if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                    echo "Fetch 失败，等待10秒后重试..."
                    sleep 10
                  fi
                fi
              done

              if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
                echo "警告: Fetch 失败，尝试继续..."
              fi

              # 自动检测并拉取当前分支
              CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
              echo "当前分支: $CURRENT_BRANCH"

              # 尝试拉取代码，带重试机制
              PULL_SUCCESS=0
              RETRY_COUNT=0
              while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ $PULL_SUCCESS -eq 0 ]; do
                echo "尝试 pull (尝试 $((RETRY_COUNT+1))/$MAX_RETRIES)..."
                if git pull origin $CURRENT_BRANCH; then
                  echo "从 $CURRENT_BRANCH 分支拉取成功"
                  PULL_SUCCESS=1
                elif git pull origin main; then
                  echo "从 main 分支拉取成功"
                  PULL_SUCCESS=1
                elif git pull origin master; then
                  echo "从 master 分支拉取成功"
                  PULL_SUCCESS=1
                else
                  RETRY_COUNT=$((RETRY_COUNT+1))
                  if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                    echo "Pull 失败，等待10秒后重试..."
                    sleep 10
                  fi
                fi
              done

              if [ $PULL_SUCCESS -eq 0 ]; then
                echo "错误: 代码拉取失败，已重试 $MAX_RETRIES 次"
                echo "提示: 请确保服务器上已正确配置GitHub SSH密钥"
                exit 1
              fi

              echo "代码更新完成"
              echo "最新提交："
              git log -1 --oneline

              # 显示当前HEAD
              echo "当前HEAD: $(git rev-parse HEAD)"
            else
              echo "=== 首次克隆仓库 ==="
              # 尝试克隆，带重试机制（使用SSH）
              RETRY_COUNT=0
              MAX_RETRIES=3
              CLONE_SUCCESS=0

              while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ $CLONE_SUCCESS -eq 0 ]; do
                echo "尝试克隆仓库 (尝试 $((RETRY_COUNT+1))/$MAX_RETRIES)..."
                if git clone git@github.com:KkNeChar0n/ZhixinStudentSaaS.git "${PROJECT_PATH}"; then
                  echo "克隆成功"
                  CLONE_SUCCESS=1
                else
                  RETRY_COUNT=$((RETRY_COUNT+1))
                  if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                    echo "克隆失败，清理临时文件并等待15秒后重试..."
                    rm -rf "${PROJECT_PATH}"
                    sleep 15
                  fi
                fi
              done

              if [ $CLONE_SUCCESS -eq 0 ]; then
                echo "错误: 仓库克隆失败，已重试 $MAX_RETRIES 次"
                echo "提示: 请确保服务器上已配置GitHub SSH密钥"
                echo "1. 生成密钥: ssh-keygen -t ed25519 -C 'your_email@example.com' -f ~/.ssh/github_deploy_key"
                echo "2. 添加公钥到GitHub: cat ~/.ssh/github_deploy_key.pub"
                echo "3. 配置SSH: 在~/.ssh/config中添加GitHub配置"
                exit 1
              fi
            fi
            
            # 安装后端依赖
            cd "${BACKEND_PATH}"
            pip3 install -r requirements.txt

            # 数据库初始化和迁移
            echo "=== 检查数据库 ==="
            DB_EXISTS=$(mysql -u root -p"qweasd123Q!" -e "SHOW DATABASES LIKE 'zhixinstudentsaas';" | grep zhixinstudentsaas)
            if [ -z "$DB_EXISTS" ]; then
              echo "数据库不存在，执行初始化..."
              if [ -f "${PROJECT_PATH}/init_database.sql" ]; then
                mysql -u root -p"qweasd123Q!" < "${PROJECT_PATH}/init_database.sql"
                echo "数据库初始化完成"
              else
                echo "警告: init_database.sql 文件不存在"
              fi
            else
              echo "数据库已存在，执行迁移脚本..."
              # 执行账号状态字段迁移
              if [ -f "${PROJECT_PATH}/add_account_status.sql" ]; then
                echo "执行账号管理字段迁移..."
                mysql -u root -p"qweasd123Q!" < "${PROJECT_PATH}/add_account_status.sql" 2>&1 || true
              fi
              # 执行status字段类型迁移
              if [ -f "${PROJECT_PATH}/migrate_status_fields.sql" ]; then
                echo "执行status字段类型迁移..."
                mysql -u root -p"qweasd123Q!" < "${PROJECT_PATH}/migrate_status_fields.sql" 2>&1 || true
              fi
              # 创建订单表
              if [ -f "${PROJECT_PATH}/create_order_table.sql" ]; then
                echo "执行订单表创建..."
                mysql -u root -p"qweasd123Q!" < "${PROJECT_PATH}/create_order_table.sql" 2>&1 || true
              fi
              # 创建菜单表
              if [ -f "${PROJECT_PATH}/create_menu_table.sql" ]; then
                echo "执行菜单表创建..."
                mysql -u root -p"qweasd123Q!" < "${PROJECT_PATH}/create_menu_table.sql" 2>&1 || true
              fi
              # 创建属性表
              if [ -f "${PROJECT_PATH}/create_attribute_table.sql" ]; then
                echo "执行属性表创建..."
                mysql -u root -p"qweasd123Q!" < "${PROJECT_PATH}/create_attribute_table.sql" 2>&1 || true
              fi
              # 添加商品管理菜单
              if [ -f "${PROJECT_PATH}/add_product_menu.sql" ]; then
                echo "执行商品管理菜单添加..."
                mysql -u root -p"qweasd123Q!" < "${PROJECT_PATH}/add_product_menu.sql" 2>&1 || true
              fi
            fi
            
            # 创建systemd服务文件 - 使用安全的方式
            SYSTEMD_CONTENT="[Unit]\nDescription=CharonSpace Backend Service\nAfter=network.target\n\n[Service]\nUser=charon\nWorkingDirectory=${BACKEND_PATH}\nEnvironment=\"DB_USER=root\"\nEnvironment=\"DB_PASSWORD=qweasd123Q!\"\nEnvironment=\"DB_HOST=localhost\"\nEnvironment=\"DB_NAME=zhixinstudentsaas\"\nExecStart=/usr/bin/python3 ${BACKEND_PATH}/app.py\nRestart=always\n\n[Install]\nWantedBy=multi-user.target"
            # 使用echo -e启用转义字符解析
            echo -e "$SYSTEMD_CONTENT" > /tmp/charonspace-backend.service
            
            # 部署服务文件
            sudo mv /tmp/charonspace-backend.service /etc/systemd/system/
            sudo systemctl daemon-reload
            sudo systemctl enable charonspace-backend
            sudo systemctl restart charonspace-backend
            
            # 前端部署 - 更详细的调试
            echo "=== 开始前端部署 ==="
            echo "当前目录：$(pwd)"
            echo "前端文件路径：${FRONTEND_PATH}"
            echo "前端目录内容："
            ls -la "${FRONTEND_PATH}"
            
            # 确保/var/www/html目录存在
            echo "创建/var/www/html目录..."
            sudo mkdir -p /var/www/html
            
            # 复制前端文件
            echo "复制前端文件到/var/www/html..."
            sudo cp -r "${FRONTEND_PATH}"/* /var/www/html/
            
            # 检查复制结果
            echo "复制完成后/var/www/html目录内容："
            sudo ls -la /var/www/html/
            
            # 检测Nginx运行用户
            echo "=== 检测Nginx运行用户 ==="
            NGINX_USER=$(ps aux | grep nginx | grep -v grep | grep -v root | head -1 | awk '{print $1}')
            if [ -z "$NGINX_USER" ]; then
              NGINX_USER=$(grep -E '^(user|group)' /etc/nginx/nginx.conf | head -1 | awk '{print $2}' | sed 's/;//')
            fi
            if [ -z "$NGINX_USER" ]; then
              NGINX_USER="nginx"  # 默认使用nginx用户
            fi
            echo "检测到Nginx运行用户：$NGINX_USER"
            
            # 设置权限 - 使用检测到的用户
            echo "设置文件权限..."
            sudo chown -R $NGINX_USER:$NGINX_USER /var/www/html/
            echo "设置权限后："
            sudo ls -la /var/www/html/
            
            # 配置Nginx反向代理
            echo "=== 开始Nginx配置 ==="
            echo "复制Nginx配置文件..."
            sudo cp "${BACKEND_PATH}/nginx.conf" /etc/nginx/conf.d/charonspace.conf
            
            # 删除默认配置以避免冲突
            echo "删除默认配置文件以避免冲突..."
            if [ -f /etc/nginx/conf.d/default.conf ]; then
              sudo rm /etc/nginx/conf.d/default.conf
              echo "已删除默认配置文件 /etc/nginx/conf.d/default.conf"
            elif [ -f /etc/nginx/sites-enabled/default ]; then
              sudo rm /etc/nginx/sites-enabled/default
              echo "已删除默认配置文件 /etc/nginx/sites-enabled/default"
            fi
            
            # 验证配置
            echo "当前Nginx配置文件："
            sudo ls -la /etc/nginx/conf.d/
            echo "我们的配置文件内容："
            sudo cat /etc/nginx/conf.d/charonspace.conf
            
            # 检查Nginx语法
            echo "检查Nginx配置语法..."
            sudo nginx -t
            
            # 重启Nginx服务
            echo "重启Nginx服务..."
            sudo systemctl restart nginx
            
            # 检查Nginx服务状态
            echo "Nginx服务状态："
            sudo systemctl status nginx --no-pager
            
            # 测试访问
            echo "测试本地访问..."
            curl -s http://localhost | head -30
            
            echo "部署完成！"
          EOF
